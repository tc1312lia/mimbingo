<script>
(function () {
  const TRACKING_URL = 'https://script.google.com/macros/s/AKfycbw_sb0oc3qbJag8lU4g7tHWsWjdWZ9iUaoCtyyjZNn0H0Muurt92DOmT_RdjPVArW6nbw/exec';

  // ðŸ” Player ID
  function getPlayerId() {
    let id = localStorage.getItem('mim_player_id');
    if (!id) {
      id = 'player-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem('mim_player_id', id);
    }
    return id;
  }

  function sendLog(payload) {
    try {
      fetch(TRACKING_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (e) {}
  }

  // ðŸŸ£ All possible tags
  const ALL_TAGS = {
    tag1: {
      label: 'Song of the Week',
      prompt: 'Ask someone what their â€œsong of the weekâ€ is â€” and tell them yours.'
    },

    tag2: {
      label: 'Meet Someone New',
      prompt: 'Find someone you havenâ€™t met yet and ask what brought them here tonight.',
      formUrl: 'https://www.melanatedinmelbourne.com/'
    },

    tag3: {
      label: 'Black and Better Than Ever',
      prompt: 'What does being your best self look like â€” even when the world doesnâ€™t expect it from you? Share one way youâ€™ve grown into a version of yourself youâ€™re proud of.',
      episodeUrl: 'https://open.spotify.com/episode/...'
    },

    tag4: {
      label: 'Compliment Swap',
      prompt: 'Swap compliments with a stranger â€” one genuine thing each.'
    },

    tag5: {
      label: 'Laugh Together',
      prompt: 'Find someone laughing and ask what made them laugh tonight.'
    },

    tag6: {
      label: 'Share a Goal',
      prompt: 'Tell someone about a goal youâ€™re working toward â€” big or small.'
    },

    tag7: {
      label: 'Tap with Host',
      prompt: 'Find a host or volunteer with a Tap In badge and introduce yourself.'
    },

    tag8: {
      label: 'Solo Moment',
      prompt: 'Take a breath. Whatâ€™s something youâ€™re grateful for in this moment?'
    },

    tag9: {
      label: 'Creative Spark',
      prompt: 'Ask someone what inspires them to create, share, or show up lately.'
    },

    tag10: {
      label: 'Stories We Need',
      prompt: 'What kind of stories do you wish you heard more often â€” in media or real life?'
    },

    tag11: {
      label: 'Grounded Space',
      prompt: 'Think about what helps you feel grounded or safe. Take a pause here.'
    },

    tag12: {
      label: 'Gratitude Tap',
      prompt: 'Share one thing that made you smile this week with someone nearby.'
    },

    tag13: {
      label: 'Find Someone in Yellow',
      prompt: 'Find someone wearing yellow or gold and give them a compliment.'
    },

    tag14: {
      label: 'Your Soundtrack',
      prompt: 'If we made a playlist for tonight, what song would you add â€” and why?',
      formUrl: 'https://open.spotify.com/playlist/...'
    },

    tag15: {
      label: 'Community Wish',
      prompt: 'Whatâ€™s one thing youâ€™d love to see more of in our creative communities?'
    },

    tag16: {
      label: 'Podcast Pitch',
      prompt: 'If you could host an episode of MiM, what would your first topic be?'
    },

    tag17: {
      label: 'Ask â€œWhat Brings You Joy?â€',
      prompt: 'Ask someone: â€œWhatâ€™s been bringing you joy lately?â€'
    },

    tag18: {
      label: 'Siki From the Block',
      prompt: 'What part of your younger self still lives in you now? Talk about a neighbourhood, moment, or community that shaped who you are.',
      episodeUrl: 'https://open.spotify.com/episode/...'
    },

    tag19: {
      label: 'Deep Breath',
      prompt: 'Pause. Take one deep breath â€” remind yourself you belong here.'
    },

    tag20: {
      label: 'Reflect & Share',
      prompt: 'Think about your younger self. Whatâ€™s one thing youâ€™d tell them now?'
    },

    tag21: {
      label: 'Selfie Tag',
      prompt: 'With someone new, take a selfie and call it your â€œEpisode 1 cover art.â€'
    },

    tag22: {
      label: 'Connection Tap',
      prompt: 'Tap this after meeting someone new â€” you both just earned a connection point.'
    },

    tag23: {
      label: 'Free Space',
      prompt: 'Youâ€™re already glowing â€” this oneâ€™s a freebie!'
    },

    tag24: {
      label: 'Proud Moment',
      prompt: 'Tell someone one thing youâ€™re proud of yourself for this year.'
    },

    tag25: {
      label: 'Find Your Way Back',
      prompt: 'When was the last time you reconnected with something that once made you happy? Share a hobby, person, or part of yourself youâ€™ve come back to.',
      episodeUrl: 'https://open.spotify.com/episode/...'
    },

    // ðŸŒ Always-present MiM Website Tag
    mim_home: {
      label: 'Melanated in Melbourne',
      prompt: 'Tap to visit our official site and explore more stories, events, and episodes.',
      episodeUrl: 'https://www.melanatedinmelbourne.com/'
    }
  };

  const STORAGE_KEY = 'mim_bingo_4x4_state_v3';

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : { collected: [], layout: [], bingoLogged: false };
    } catch {
      return { collected: [], layout: [], bingoLogged: false };
    }
  }

  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  const state = loadState();
  const allKeys = Object.keys(ALL_TAGS);

  // ðŸ”„ Generate randomised 4x4 board with pinned MiM link
  if (!state.layout || state.layout.length !== 16) {
    const pinnedTag = 'mim_home';
    const randomTags = shuffle(allKeys)
      .filter(k => k !== pinnedTag)
      .slice(0, 15);
    state.layout = [...randomTags, pinnedTag];
    state.collected = [];
    state.bingoLogged = false;
    saveState(state);
    sendLog({ event: 'board_created', playerId: getPlayerId(), tagId: null });
  }

  const TAGS = {};
  state.layout.forEach(k => { TAGS[k] = ALL_TAGS[k]; });

  const params = new URLSearchParams(window.location.search);
  const tagParam = (params.get('tag') || '').trim();

  const messageEl = document.getElementById('message');
  const grid = document.getElementById('bingo-grid');
  const reward = document.getElementById('reward');

  // ðŸŸ£ Handle tag scans
  if (tagParam && TAGS[tagParam]) {
    const isNew = !state.collected.includes(tagParam);
    if (isNew) {
      state.collected.push(tagParam);
      saveState(state);
      sendLog({ event: 'tag_unlocked', playerId: getPlayerId(), tagId: tagParam });
    }

    const cfg = TAGS[tagParam];
    let html = `
      <div style="font-weight:600;">âœ… You unlocked: ${cfg.label}</div>
      <div style="margin-top:6px;color:#cbb9e5;font-size:0.9rem;">
        ${cfg.prompt}
      </div>
    `;

    // Add visit button if link available
    if (cfg.episodeUrl || cfg.formUrl) {
      const link = cfg.episodeUrl || cfg.formUrl;
      html += `
        <a href="${link}" target="_blank" rel="noopener noreferrer"
          style="display:inline-block;margin-top:10px;padding:8px 14px;border-radius:999px;
          background:#ffca28;color:#3e2723;font-weight:600;font-size:0.85rem;text-decoration:none;">
          Visit
        </a>`;
    }

    messageEl.innerHTML = html;
  } else if (!tagParam) {
    messageEl.textContent = 'Tap a tag to fill your 4Ã—4 Bingo board!';
  } else {
    messageEl.textContent = 'That tag isnâ€™t part of your board tonight.';
  }

  renderBoard();
  checkForBingo();

  function renderBoard() {
    grid.innerHTML = '';
    grid.style.gridTemplateColumns = 'repeat(4, 1fr)';
    Object.entries(TAGS).forEach(([id, cfg]) => {
      const sq = document.createElement('div');
      sq.className = 'square' + (state.collected.includes(id) ? ' filled' : '');
      sq.textContent = cfg.label;
      grid.appendChild(sq);
    });
  }

  function checkForBingo() {
    const filled = state.collected;
    const ids = Object.keys(TAGS);
    const board = Array.from({ length: 4 }, (_, r) => ids.slice(r * 4, (r + 1) * 4));

    const hasRow = board.some(row => row.every(id => filled.includes(id)));
    const hasCol = [...Array(4).keys()].some(c => board.every(row => filled.includes(row[c])));
    const hasDiag1 = board.every((row, i) => filled.includes(row[i]));
    const hasDiag2 = board.every((row, i) => filled.includes(row[3 - i]));

    if (hasRow || hasCol || hasDiag1 || hasDiag2) {
      reward.style.display = 'block';
      if (!state.bingoLogged) {
        state.bingoLogged = true;
        saveState(state);
        sendLog({ event: 'bingo_completed', playerId: getPlayerId(), tagId: null });
      }
    }
  }

  function shuffle(arr) {
    return arr
      .map(v => ({ v, r: Math.random() }))
      .sort((a, b) => a.r - b.r)
      .map(o => o.v);
  }
})();
</script>
