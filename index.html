<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tap In Bingo | Melanated in Melbourne</title>
  <style>
    :root{
      --mim-purple:#4527a0; --mim-dark:#1b0b30; --mim-gold:#ffca28; --mim-gold-soft:#ffd54f;
      --text-light:#fdf7ff; --text-muted:#cbb9e5;
    }
    body{
      margin:0; min-height:100vh;
      background:radial-gradient(circle at top,var(--mim-purple),var(--mim-dark));
      color:var(--text-light);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      display:flex; flex-direction:column; align-items:center;
      padding:20px;
    }
    .brand{ font-weight:700; text-transform:uppercase; letter-spacing:.05em; color:var(--mim-gold); margin-top:4px; }
    h1{ margin:10px 0 6px; font-size:42px; }
    .subtitle{ margin:0 0 16px; color:var(--text-muted); text-align:center; max-width:820px; font-size:22px; }
    .banner{
      width:min(92vw,820px);
      background:rgba(34,21,54,.85);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:14px;
      text-align:center;
      margin:10px 0 14px;
      font-size:18px;
    }
    .bingo-board{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      width:min(92vw,380px);
      margin:10px 0 14px;
    }
    .square{
      background:rgba(28,20,52,.85);
      border:1px solid rgba(255,255,255,.18);
      border-radius:12px;
      min-height:110px; /* Safari-safe (no aspect-ratio dependency) */
      display:flex; align-items:center; justify-content:center;
      padding:10px;
      text-align:center;
      font-size:14px;
      line-height:1.2;
    }
    .square.filled{
      background:var(--mim-gold);
      color:var(--mim-dark);
      font-weight:800;
      box-shadow:0 0 12px rgba(255,213,79,.45);
    }
    .square.role{ border:2px solid rgba(255,202,40,.55); }
    .btn{
      display:inline-block;
      padding:12px 18px;
      border-radius:999px;
      background:var(--mim-gold);
      color:var(--mim-dark);
      font-weight:800;
      text-decoration:none;
      margin-top:8px;
    }
    .reward{
      display:none;
      width:min(92vw,820px);
      border:1px solid var(--mim-gold-soft);
      border-radius:14px;
      background:rgba(255,214,79,.1);
      color:var(--mim-gold);
      padding:14px;
      text-align:center;
      margin-top:10px;
      font-size:18px;
    }
    .debug{
      width:min(92vw,820px);
      margin-top:12px;
      color:#ffd1d1;
      font-size:14px;
      white-space:pre-wrap;
      opacity:.95;
    }
  </style>
</head>

<body>
  <div class="brand">Melanated in Melbourne</div>
  <h1>Tap In Bingo</h1>
  <p class="subtitle">Scan NFC tags around the space. Fill a row, column, or diagonal on your 3Ã—3 board to win!</p>

  <div id="message" class="banner">Loaded HTML âœ… (now running JavaScriptâ€¦)</div>
  <div id="bingo-grid" class="bingo-board"></div>

  <a class="btn" href="https://www.melanatedinmelbourne.com/">Visit Melanated in Melbourne</a>

  <div id="reward" class="reward">ðŸŽ‰ Bingo! Youâ€™ve completed a Tap In line â€” show this to a host for your reward.</div>
  <div id="debug" class="debug"></div>

<script>
(function(){
  const debugEl = document.getElementById('debug');
  function debug(msg){ debugEl.textContent += msg + "\n"; }

  try {
    const BOARD_SIZE = 3;
    const STORAGE_KEY = 'mim_bingo_v10'; // bump to force fresh layout

    function getPlayerId(){
      let id = localStorage.getItem('mim_player_id');
      if(!id){
        id = 'player-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem('mim_player_id', id);
      }
      return id;
    }
    getPlayerId();

    const ALL_TAGS = {
      // pinned roles
      first_timer:{label:'First-timer (Green)',prompt:'Welcome someone wearing a GREEN lanyard.'},
      performer:{label:'Performer (Purple)',prompt:'Find a PURPLE lanyard. Ask what theyâ€™re sharing tonight.'},
      organiser:{label:'Organiser (Black)',prompt:'Find a BLACK lanyard. Ask what theyâ€™re excited for tonight.'},
      volunteer:{label:'Volunteer (Orange)',prompt:'Find an ORANGE lanyard. Ask how to join in.'},

      // a few fun tiles (expand this list later)
      tag1:{label:'Song of the Week',prompt:'Share your song of the week.'},
      tag2:{label:'Meet Someone New',prompt:'Talk to someone you havenâ€™t met yet.'},
      tag3:{label:'Creative Spark',prompt:'Ask whatâ€™s inspiring someone lately.'},
      tag4:{label:'Gratitude Tap',prompt:'Share one thing youâ€™re grateful for.'},
      tag5:{label:'Laugh Together',prompt:'Share something funny tonight.'},
      mim_home:{label:'MiM Home',prompt:'Visit the MiM site.'}
    };

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"layout":[],"collected":[],"bingo":false}');
    const allKeys = Object.keys(ALL_TAGS);

    if(!state.layout || state.layout.length !== 9){
      const pinned = ['first_timer','performer','organiser','volunteer']; // mim_home is RANDOM
      const pool = allKeys.filter(k => !pinned.includes(k));
      const random = shuffle(pool).slice(0, 9 - pinned.length); // 5 random
      state.layout = random.concat(pinned);
      state.collected = [];
      state.bingo = false;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      debug("Created new board layout: " + JSON.stringify(state.layout));
    } else {
      debug("Loaded existing board layout: " + JSON.stringify(state.layout));
    }

    const TAGS = {};
    state.layout.forEach(k => TAGS[k] = ALL_TAGS[k]);

    const params = new URLSearchParams(location.search);
    const tagParam = (params.get('tag') || '').trim();

    const message = document.getElementById('message');
    const grid = document.getElementById('bingo-grid');
    const reward = document.getElementById('reward');

    if(tagParam){
      debug("URL tag param = " + tagParam);
    } else {
      debug("No tag param in URL");
    }

    if(tagParam && TAGS[tagParam]){
      if(!state.collected.includes(tagParam)){
        state.collected.push(tagParam);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        debug("Collected new tag: " + tagParam);
      } else {
        debug("Tag already collected: " + tagParam);
      }
      message.innerHTML = "<strong>âœ… You unlocked: " + escapeHtml(TAGS[tagParam].label) + "</strong><br>" +
                         escapeHtml(TAGS[tagParam].prompt);
    } else {
      message.textContent = "Tap a tag to fill your 3Ã—3 Bingo board!";
      if(tagParam) debug("Tag not on this board: " + tagParam);
    }

    renderBoard();
    checkBingo();

    function renderBoard(){
      grid.innerHTML = "";
      const roleSet = new Set(['first_timer','performer','organiser','volunteer']);
      Object.keys(TAGS).forEach(id => {
        const sq = document.createElement("div");
        const isRole = roleSet.has(id);
        const isFilled = state.collected.indexOf(id) !== -1;
        sq.className = "square" + (isRole ? " role" : "") + (isFilled ? " filled" : "");
        sq.textContent = TAGS[id].label;
        grid.appendChild(sq);
      });
      debug("Rendered board squares: " + Object.keys(TAGS).length);
    }

    function checkBingo(){
      const f = state.collected;
      const ids = Object.keys(TAGS);
      const b = [ids.slice(0,3), ids.slice(3,6), ids.slice(6,9)];
      const win =
        b.some(r => r.every(i => f.indexOf(i) !== -1)) ||
        [0,1,2].some(c => b.every(r => f.indexOf(r[c]) !== -1)) ||
        b.every((r,i) => f.indexOf(r[i]) !== -1) ||
        b.every((r,i) => f.indexOf(r[2-i]) !== -1);

      if(win){
        reward.style.display = "block";
        debug("BINGO = true");
      } else {
        debug("BINGO = false");
      }
    }

    function shuffle(a){
      return a
        .map(v => ({v, r: Math.random()}))
        .sort((x,y) => x.r - y.r)
        .map(o => o.v);
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

  } catch (err) {
    document.getElementById('message').textContent = "JavaScript error â€” see debug below.";
    debug("ERROR:\n" + (err && err.stack ? err.stack : String(err)));
  }
})();
</script>
</body>
</html>
