<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title> MIM BINGO </title>
<style>
  :root {
    --mim-purple: #4527a0;
    --mim-dark: #1b0b30;
    --mim-gold: #ffca28;
    --mim-gold-soft: #ffd54f;
    --text-light: #fdf7ff;
    --text-muted: #cbb9e5;
  }

 body {
  margin: 0;
  min-height: 100vh;

  background:
    linear-gradient(rgba(27, 11, 48, 0.4), rgba(27, 11, 48, 0.4)),
    url("assets/bingo bakgrounf.png");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;

  color: var(--text-light);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  }

  .brand {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--mim-gold);
    margin-bottom: 6px;
  }

  h1 { margin: 0 0 8px; }

  .subtitle {
    margin-top: 300px
    margin-bottom: 16px;
    color: var(--text-muted);
    text-align: center;
  }

  .banner {
    background: rgba(34, 21, 54, 0.85);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    margin-bottom: 14px;
  }

/* 3x3 grid */
.bingo-board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  width: min(90vw, 360px);
  margin-bottom: 14px;
}
 
  .square {
    background: rgba(28, 20, 52, 0.85);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 10px;
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    text-align: center;
    font-size: 0.8rem;
    line-height: 1.2;
    overflow-wrap: break-word;
    transition: all 0.3s ease;
  }

  .square.filled {
    background: var(--mim-gold);
    color: var(--mim-dark);
    font-weight: 600;
    box-shadow: 0 0 10px rgba(255, 213, 79, 0.5);
  }

  .reward {
    display: none;
    border: 1px solid var(--mim-gold-soft);
    border-radius: 12px;
    background: rgba(255, 214, 79, 0.1);
    color: var(--mim-gold);
    padding: 14px;
    text-align: center;
  }

  .mim-button {
    margin-top: 16px;
    display: inline-block;
    padding: 10px 18px;
    border-radius: 999px;
    background: var(--mim-gold);
    color: var(--mim-dark);
    font-weight: 600;
    text-decoration: none;
    font-size: 0.9rem;
  }
</style>
</head>

<body>
<p class="subtitle">
  Scan NFC tags around the space. Fill a row, column, or diagonal on your 3Ã—3 board to win!
</p>

<div id="message" class="banner">Loadingâ€¦</div>
<div id="bingo-grid" class="bingo-board"></div>

<a href="https://www.melanatedinmelbourne.com/" class="mim-button">
  Visit Melanated in Melbourne
</a>

<div id="reward" class="reward">
ðŸŽ‰ Bingo! Youâ€™ve completed a Tap In line â€” show this to a host for your reward.
</div>

<script>
(function(){
const TRACKING_URL = 'https://script.google.com/macros/s/AKfycbw_sb0oc3qbJag8lU4g7tHWsWjdWZ9iUaoCtyyjZNn0H0Muurt92DOmT_RdjPVArW6nbw/exec';

/* stable player identity */
function getPlayerName(){
  let n = localStorage.getItem('mim_player_name');
  if(!n){
    n = prompt("Enter your name (first name or nickname):") || "Guest";
    localStorage.setItem('mim_player_name', n);
  }
  return n;
}
function getOrCreateNameSuffix(){
  let s = localStorage.getItem('mim_name_suffix');
  if(!s){
    s = String(Math.floor(Math.random()*1000));
    localStorage.setItem('mim_name_suffix', s);
  }
  return s;
}
function makeStablePlayerId(name){
  const base = String(name).toLowerCase().replace(/[^a-z0-9]/g,'') || 'guest';
  return `player-${base}-${getOrCreateNameSuffix()}`;
}

const playerName = getPlayerName();
const playerId   = makeStablePlayerId(playerName);

function sendLog(p){
  try{
    fetch(TRACKING_URL,{
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({...p, playerName, playerId})
    });
  }catch(e){}
}

/* tags */
const ALL_TAGS={
tag1:{label:'Volunteer',prompt:'Congrats! You found a volunteer tag.'},
tag2:{label:'Meet Someone New',prompt:'Congrats! You found a newbie tag.'},
tag3:{label:'Gqom Girl',prompt:'50th episode!',episodeUrl:'https://open.spotify.com/episode/7bkqqPhmVyCqX4uOSMGuIT?si=ec4c509b098c49fc'},
tag4:{label:'Share a Goal',prompt:'Tell someone about a goal youâ€™re working toward.'},
tag5:{label:'Make a New Friend',prompt:'Congrats! You found a new friend tag.'},
tag6:{label:'Stories We Need',prompt:'What stories do you want more of?',formUrl:'https://forms.gle/w73o1BtQ3H3ZBz3L6'},
tag7:{label:'Grounded Space',prompt:'Pause and take a breath.'},
tag8:{label:'Follow Us!',prompt:'Not following yet? ðŸ‘‰ Tap here to follow us on Instagram.',formUrl:'https://www.instagram.com/melanatedinmelbourne/'},
tag9:{label:'Community Wish',prompt:'What do you want more of?',formUrl:'https://forms.gle/Bw4Gwf3yB6bQ95WP8'},
tag10:{label:'To Be Loved',prompt:'What/s been your dating experience in Melbourne?',episodeUrl:'https://open.spotify.com/episode/4OGs7XIUsJrMwwEQydhZiT?si=e6b34fb781a74052'},
tag11:{label:'No Nutbush November',prompt:'An honest conversation unpacking HIV and AIDS myths, stigma, and progress.',episodeUrl:'https://open.spotify.com/episode/4yt7R2y10fgPwVP7BfjzWx?si=606c627299b1485d'},
tag12:{label:'Expand the circle',prompt:'Invite someone standing alone to join your conversation.'},
tag13:{label:'Make a connection',prompt:'Introduce two people who havenâ€™t met yet.'},
tag14:{label:'Capture a moment ðŸ“¸',prompt:'Take a photo with someone'},
tag15:{label:'Ask someone',prompt:'Which performer are you most excited to see tonight?.'}
};

/* 3x3 state */
const STORAGE_KEY='mim_bingo_v8_3x3';
let state=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{"collected":[],"layout":[],"bingoLogged":false}');
const allKeys=Object.keys(ALL_TAGS);

if(!state.layout || state.layout.length!==9){
  state.layout = shuffle(allKeys).slice(0,9);
  state.collected=[];
  state.bingoLogged=false;
  localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
  sendLog({event:'board_created',tagId:null});
}

const TAGS={};
state.layout.forEach(k=>TAGS[k]=ALL_TAGS[k]);

/* scan handling */
/* scan handling */
const params = new URLSearchParams(window.location.search);
const tagParam = (params.get('tag') || '').trim();
const messageEl = document.getElementById('message');
const grid = document.getElementById('bingo-grid');
const reward = document.getElementById('reward');

if (tagParam) {
  if (TAGS[tagParam]) {
    if (!state.collected.includes(tagParam)) {
      state.collected.push(tagParam);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      sendLog({ event: 'tag_unlocked', tagId: tagParam });
    }

    const cfg = TAGS[tagParam];
    let html = `<strong>âœ… You unlocked: ${cfg.label}</strong><br>${cfg.prompt}`;

    if (cfg.episodeUrl || cfg.formUrl) {
      const link = cfg.episodeUrl || cfg.formUrl;
      html += `<br><a href="${link}" target="_blank" class="mim-button">Open</a>`;
    }

    messageEl.innerHTML = html;
  } else {
    messageEl.innerHTML =
      `<strong>Not on your board â€” thatâ€™s okay!</strong><br>` +
      `Say hello to someone nearby and keep exploring.`;
    sendLog({ event: 'tag_not_on_board', tagId: tagParam });
  }
} else {
  messageEl.textContent = 'Tap a tag to fill your 3Ã—3 Bingo board!';
}


renderBoard();
checkBingo();

/* render */
function renderBoard(){
  grid.innerHTML='';
  grid.style.gridTemplateColumns='repeat(3,1fr)';
  Object.entries(TAGS).forEach(([id,cfg])=>{
    const sq=document.createElement('div');
    sq.className='square'+(state.collected.includes(id)?' filled':'');
    sq.textContent=cfg.label;
    grid.appendChild(sq);
  });
}

/* bingo logic */
function checkBingo(){
  const f=state.collected;
  const ids=Object.keys(TAGS);
  const b=[ids.slice(0,3),ids.slice(3,6),ids.slice(6,9)];
  const win =
    b.some(r=>r.every(i=>f.includes(i))) ||
    [0,1,2].some(c=>b.every(r=>f.includes(r[c]))) ||
    b.every((r,i)=>f.includes(r[i])) ||
    b.every((r,i)=>f.includes(r[2-i]));
  if(win){
    reward.style.display='block';
    if(!state.bingoLogged){
      state.bingoLogged=true;
      localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
      sendLog({event:'bingo_completed',tagId:null});
    }
  }
}

function shuffle(a){
  return a.map(v=>({v,r:Math.random()})).sort((a,b)=>a.r-b.r).map(o=>o.v);
}
})();
</script>
</body>
</html>
